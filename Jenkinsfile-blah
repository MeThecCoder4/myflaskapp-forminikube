node('docker&&linux') {
    def app

    stage('Checkout and Sync Repo') {
        /* Let's make sure we have the repository cloned to our workspace */

        cleanWs()
        checkout scm
    }

    stage('Build image') {
        /* This builds the actual image; synonymous to
         * docker build on the command line */
        sh "ls -l"
        sh "pwd"
        def clusterInfo = readFile "test.txt"
        def clusterMap = readClusterInfo(clusterInfo);
        print clusterMap;
        app = docker.build("manishjindal/myflaskapp-forminikube")
    }

    stage('Test image') {
        /* Ideally, we would run a test framework against our image.
         * For this example, we're using a Volkswagen-type approach ;-) */

        app.inside {
            sh 'echo "Tests passed"'
        }
    }

}

 def ArrayList<Map<String, String>> readClusterInfo(String clusterInfoContent) {

    def cluster = new ArrayList<Map<String, String>>();

    def lines= clusterInfoContent.split("\n");
    
    print lines.toString();
    
    for (int i=0;i<lines.size();i++) {
        clusterDeatils = lines[i].trim().split(",");
        clusterMap = new HashMap<String, String>();
        for (int j = 0; j < clusterDeatils.size(); j++) {
            clusterElements = (clusterDeatils.getAt(j)).toString().split(":");
            clusterMap.put(clusterElements.getAt(0), clusterElements.getAt(1));
        }
        cluster.add(clusterMap);
    }
    cluster
  }
